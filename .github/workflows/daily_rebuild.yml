name: Daily rebuild of ClamAV docker image with latest definitions

on:
  schedule:
  - cron: "*/15 * * * *"

jobs:
  daily_rebuild:

    runs-on: ubuntu-latest
    
    steps:
    - name: Update latest version definition
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Update latest version definition script
        cd $GITHUB_WORKSPACE
        git init
        git pull https://x-access-token:${GITHUB_TOKEN}@github.com/citizensadvice/clamav-docker.git
        git checkout master
        
        # ClamAV publishes version numbers through DNS
        # We publish that version number to the repository
        # This is also used in the suggested local mirror update scripts
        # https://www.clamav.net/documents/private-local-mirrors
        regex="current\.cvd\.clamav\.net.+text.*=.*\"(.*)\""
        if [[ $(nslookup -type=TXT current.cvd.clamav.net) =~ $regex ]]
        then 
          current_version=${BASH_REMATCH[1]}
          echo "$current_version" > ./current.cvd.clamav.net.txt
          echo "Updating to cvd $current_version"

          # Configure git to run as an infrastructure user
          git config --global user.email "ca-devops@citizensadvice.org.uk"
          git config --global user.name "Citizens Advice GitHub Action"

          git checkout master

          # Push the change
          git add ./current.cvd.clamav.net.txt
          git commit -a -m "Version update to $current_version"
          git push
        else
          echo "Couldn't fetch clamav signature versions."
          exit 1
        fi
